name: PR Auto Merge

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  queue-auto-merge:
    name: Queue Auto Merge
    if: >
      github.event.pull_request.state == 'open' &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge queue (squash)
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set +e
          output=$(gh pr merge "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --auto --squash --delete-branch 2>&1)
          code=$?
          set -e
          if [ "$code" -eq 0 ]; then
            echo "$output"
            exit 0
          fi
          if echo "$output" | grep -qi "already"; then
            echo "$output"
            exit 0
          fi
          echo "$output"
          exit "$code"
